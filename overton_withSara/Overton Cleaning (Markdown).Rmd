---
title: "Overton Cleaning (Markdown)"
author: "Khristiannne L Ermino"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: kable
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 60), tidy=TRUE)
```

```{r}
library(tidyverse)
```

# Loading In Reports CSV
```{r}
df <-read_delim("overton_withSara/reports.csv")
```

# Creating a Test Trial
```{r}
test <-df[1:5,] %>% 
  select ("Title of citing document") %>%
  rename(title = "Title of citing document")
```

Rather than figuring out code for all ~26,000 entries, it would be easier to work on it with a smaller test set. Therefore, the first 5 entries from the database were chosen from the "Title of citing document" column. This long titles was renamed as "title" for the sake of efficiency when coding. 

# Testing Regex for String Extraction and Create a New Column with the Date
```{r}
str_extract(test$title,"(\\d\\d\\d\\d)+(?=E)")
```

Using the str_extract function, we are accessing the column "title" from the data frame called "test". This allows us to extract the 4 wildcard digits that occur before the "E". Since we're working with a test set of the first 5 entries, we know that they should all be "2010". This allows us to check if the code has worked in the way we want it to. 

```{r}
test %>% 
  mutate(year = str_extract(test$title,"(\\d\\d\\d\\d)+(?=E)")) 
```

Using the mutate function alongside the str_extract function, the 4 wildcard digits that are before the "E" from the title in the "test" data frame is taken and mutated to create a new column in the "test" data frame called "year". 

# Testing the Separate Function for Species Name Pull
```{r}
test %>%
  separate(title, into = c(NA, "int1"), sep = "COSEWIC assessment and status report on the ") %>% 
  separate(int1, into = c("full.spp", NA), sep = ", in Canada") %>%
  separate(full.spp, into = c("Common", "Latin"), sep = ', ')
```

In the title column of the "test" data frame, the contents are separated using the separate function. The separator is "COSEWIC..." with the contents prior to the separator being ignored  while the contents after the separator are placed into a column labelled "int1" (NA, "int1"). 

The separate function is used once again, with the contents of the int1 column being separated using ", in Canada" as the separator. The contents prior to the separator are placed into a column labelled "full.spp" while the contents prior are ignored. 

Using the separate function, the contents of the "full.spp" column is separated with the separator being ", ", keeping the contents of both sides of the separator with the contents prior placed in the "Common" column and the contents after the separator placed in the "Latin" column.

# Full df Clean 
```{r}
df.pub.year <- df %>% 
  rename(title = "Title of citing document", pub.date = "Published on date of citing document") %>%
  separate(pub.date, into = c("pub.year"), sep = '-', extra = "drop") 
```

Cleaning title names and separating the year of publication from the "pub.date" column. From the loaded overton database called "df', the long titles were renamed for more efficient coding. Separates the first part of the "pub.date" using the "-" separator and drops the other parts. 

## Making Intermediate Obj So That the String Extract Works Properly
```{r}
int.year <- df.pub.year %>%
  mutate(year = str_extract(df.pub.year$title,"(\\d\\d\\d\\d)+(?=E)"))
```

Using the str_extract, from the "title" column of the df.pub.year" data frame, take out the four wildcard digits that are found before the "E". Using the mutate function, a "year" column is created in the "int.year" data frame. 

## Make Intermediate Obj to Replace Year with pub.year If Year is NA
```{r}
int.year.narepl <- int.year %>%
  mutate(year = ifelse(is.na(int.year$year), int.year$pub.year, int.year$year))
```

Uses an IF-ELSE function!!
There's a new column called "year" which already exists in the "int.year" object. If there's no information in the int.year column pull the information from "pub.year" column. 

## Create Clean Dataframe with "spp names" Pulled Out into Common and Latin Columns
```{r}
df.clean <- int.year.narepl %>%
  mutate(pub.title = title) %>%
  separate(title, into = c(NA, "int1"), sep = "COSEWIC assessment and status report on ") %>%
  separate(int1, into = c("full.spp", NA), sep = ", in Canada") %>%
  separate(full.spp, into = c("common", "latin"), sep = ', ') %>%
  select(common, latin, year, `Cited source or journal`, pub.year, pub.title)
```

Trial and error, separator can't include "the" because of the way they wrote the title. 

Line 1: 
To create a new data frame called "df.clean", the mutate function is used to create "pub.title" column from the "title" column from "int.year.narepl" data frame. 

Line2: 
Using the separate function, the title column from "int.year.narepl" was separated using "COSEWIC..." as the separator with any contents prior being ignored and contents after placed in a column called "int1". 

Line 3: 
Using the separate function, the "int1" column from "int.year.narepl" was separated with ", " being the separator with any contents prior to the separator being placed into a column called "full.spp" and contents after the separator being ignored. 

Line 4:
Using the separate function, the "full.spp" column was separated into two separate columns using ", " as the separator. Any contents prior to the separator are placed into a column called "common" and the contents after the separator are placed into a column called "latin". 

Line 5: 
Using the select function, only certain columns from the "int.year.narepl" data frame are selected to be in the new "df.clean" column. These columns are common, latin, year, 'Cited source or journal', pub.year. and pub.title. 

Some NAs in the species name is due to differing titles of reports - mostly that some reports are 'update status' rather than 'status'.

Some species were listed as NA in the common name as the titles were written slightly different. 

## Pull All the Species that have NA as Common because They're Update Reports
```{r}
update.spp <- df.clean %>%
  filter(is.na(common))
```

Using the filter function, a new data frame is created from "df.clean" where the "common" column has NA entries. 

## Separate All Names Based on Update Status Report
```{r}
update.clean <- update.spp %>%
  separate(pub.title, into = c(NA, "int1"), sep = "COSEWIC assessment and update status report on ", remove = F) %>%
  separate(int1, into = c("full.spp", NA), sep = ", in Canada") %>%
  separate(full.spp, into = c("common", "latin"), sep = ', ') %>%
  select(common, latin, year, `Cited source or journal`, pub.year, pub.title)
```

Test to see if there are any NAs left. 
```{r}
update.clean %>%
  distinct(common) %>%
  filter(is.na(common))
#Shows there aren't NAs left, therefore it worked. 

head(df.clean)
head(update.clean)
```

## Removal of All Spp with Common = NA
```{r}
df.clean.noups <- df.clean %>%
  filter(!is.na(common))
# Removing these spp becase those spp are now in update.clean
```

## Status Report Spp and Update Status Report Spp are Combined
```{r}
df.clean.combo <- bind_rows(df.clean.noups, update.clean)
```

Checking for any NAs in the common name column. 
```{r}
missing.common <- df.clean.combo %>%
  filter(is.na(common)) # none! 
```

Checking for any NAs in the latin name column. 
```{r}
missing.latin <- df.clean.combo %>%
  filter(is.na(latin)) 
# Shows 872 species. 
```

## Cleaning the "missing.latin" Dataframe
```{r}
clean.missing.lat <- missing.latin %>%
  separate(common, into = c(NA, "common"), sep = 'the ') %>%
  separate(common, into = c("common", NA), sep = ' in Canada.') %>%
  separate(common, into = c("common", "latin"), sep = ' \\(')
```

Line 1: 
Using the separate function, the "common" column from "missing.latin" is separated using the separator "the " and the contents prior are ignored while the contents after the separator are placed into a new column in the "clean.missing.lat" df called "common". 

Line 2: 
Using the separate function, the "common" column from "missing.latin" is separated using the separator " in Canada." and the contents prior are placed into a new column in the "clean.missing.lat" df called "common" while the contents after the separator are ignored. 

Line 3: 
Using the separate function, the "common" column from "missing.latin" is separated using the separator " \\(" with the contents prior placed into a column in "clean.missing.lat" df called "common" and the contents after are placed into a column called "latin". 

```{r}
clean.missing.lat$latin <- gsub(")", "", clean.missing.lat$latin)
```
In the latin column a gsub ")" replace it with noting in the clean.missing.lat$latin column which will be save in the clean.missing.lat.

# Remove spp with NAs in Latin 
```{r}
final.clean <- df.clean.combo %>%
  filter(!is.na(latin)) %>% 
  bind_rows(clean.missing.lat) %>%
  separate(common, into = c(NA, "common"), sep = 'the ') %>%
  rename(source = "Cited source or journal")
```
The final.clean data frame contains missing species that don't have latin names. 

# Entries that Require Manual Changing due to Pattern Inconsistencies
```{r}
missing.latin.final <- final.clean %>% 
  filter(is.na(latin)) %>%
  distinct(pub.title) # only NA 
# All reports in the current data frame that don't have a latin name. 
```

# Looking for Species without Common Names
```{r}
missing.common.final <- final.clean %>%
  filter(is.na(common)) %>%
  distinct(latin)
```
Requires manual placement of common names for the species. 

# Duplication Years - Find the Most Recent
```{r}
dup.years <- final.clean %>%
  select(-c(source)) %>%
  group_by(common, latin) %>%
  summarise(n.years = n_distinct(year), .groups = "drop") %>%
  filter(n.years > 1)
```
66 species that have more than 2 observation. Find more recent year and choose that one.Make a clean csv without the duplicates.

# Write Out CSVs
```{r}
write_delim(missing.latin.final, "overton_withSara/missingLatin.csv", delim = ',')
write_delim(missing.common.final, "overton_withSara/missingCommon.csv", delim = ',')
write_delim(dup.years, "overton_withSara/dupYears.csv", delim = ',')
write_delim(final.clean, "overton_withSara/cleanDB.csv", delim = ',')
```

